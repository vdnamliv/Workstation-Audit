events { worker_connections 1024; }

http {
    # Rate limiting zones
    limit_req_zone $binary_remote_addr zone=bootstrap_rate:10m rate=10r/m;
    limit_req_zone $binary_remote_addr zone=api_rate:10m rate=100r/s;
    
    # Upstream definitions từ conf.d/00-upstream.conf[.local]
    include /etc/nginx/conf.d/*.conf;

    # --- Server Block cho Admin Dashboard (Port 8443) ---
    server {
        listen 8443 ssl;
        server_name _; # Nhận mọi domain trỏ về IP VIP

        # SSL Certs (Mount từ volume vào)
        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;

        location /api/ {
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /auth/ {
            proxy_pass http://keycloak_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }
    }

    # --- Server Block cho Agent (Port 443) ---
    server {
        listen 443 ssl;
        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        
        # Cấu hình mTLS cho Agent ở đây nếu cần verify client certificate
        
        location / {
            proxy_pass http://api_agent;
        }
    }
}