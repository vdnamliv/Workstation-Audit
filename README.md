# VT Audit Platform

VT Audit is a two-sided compliance monitoring stack:

- **Agents** enrol over mutual TLS, fetch audit policies, and push findings.
- **Admins** sign in with Keycloak SSO, view dashboards, and publish policies.

The stack is delivered as a reproducible Docker Compose bundle that wires together the gateway, Step-CA, API services, dashboard SPA, oauth2-proxy, Keycloak, and PostgreSQL.

---

## 1. Architecture Overview

| Service | Purpose | Port | Exposure |
|---------|---------|------|----------|
| stepca (Smallstep CA) | Issues short-lived mTLS certs for agents using a JWK provisioner | 9000 | backend network only |
| gateway (nginx) | Single public entrypoint. Terminates TLS, enforces client certs for agents, proxies dashboard traffic | 443 | host ? container |
| oidc-proxy (oauth2-proxy) | Fronts the admin API, handles OIDC login with Keycloak, issues session cookies | 4180 | backend network only |
| keycloak | Identity provider for admins | 8080 | backend network only (optionally exposed) |
| api-agent (vt-server --mode=agent) | Agent-facing API: bootstrap OTT tokens, enrolment, policy delivery, result ingest | 8080 | backend network only |
| api-user (vt-server --mode=dashboard) | Admin API: exposes /dashboard/api/* for the SPA, enforces OIDC tokens | 8081 | backend network only |
| dashboard | Static SPA (HTML/JS/CSS) served by nginx | 80 | backend network only |
| postgres | Shared database for policies, results, and Keycloak | 5432 | backend network only |

Two Docker networks are created: frontend (only the gateway) and backend (all internal services). Agents and admins only touch port **443** on the host.

### Connection flows

1. **Agent bootstrap**
   1. Agent calls POST https://gateway.local/agent/bootstrap/ott with a shared bootstrap token.
   2. api-agent mints a JWK one-time token via Step-CA and returns the Step-CA audience URL plus the CA bundle.
   3. Agent exchanges the OTT with Step-CA for a short-lived client certificate.
   4. Subsequent calls present the cert to the gateway (mTLS). Metadata is forwarded via X-Client-* headers to api-agent.
   5. Agent enrols (/agent/enroll), fetches policies, runs audits, and submits results over mTLS.

2. **Admin dashboard**
   1. Browser loads https://gateway.local/dashboard/ (SPA assets served by vt-dashboard).
   2. SPA calls /dashboard/api/*; the gateway proxies to oauth2-proxy.
   3. oauth2-proxy redirects unauthenticated sessions to Keycloak.
   4. After login, oauth2-proxy sets a secure session cookie and forwards the request to api-user with an OIDC bearer token.
   5. api-user verifies the token against Keycloak and returns JSON for the SPA.

---

## 2. Prerequisites

- Docker Engine 24+ and Docker Compose plugin.
- A DNS entry (or /etc/hosts entry) that points gateway.local to the deployment host.
- TLS material for the gateway (server.pem/server.key). For production, use an enterprise CA; for testing you can self-sign.
- Ability to back up the Step-CA root/intermediate keys (stepca_data volume) offline.

---

## 3. Prepare Configuration

1. Copy the sample environment file and fill in secrets:

   ```
   cd env
   Copy-Item .env.example .env
   edit .env to set strong passwords, client secrets, and the bootstrap token
   ```

   Key fields:
   - OIDC_CLIENT_SECRET, OIDC_COOKIE_SECRET: oauth2-proxy credentials.
   - STEPCA_PASSWORD: unlocks the provisioner JWK generated by Step-CA on first boot.
   - AGENT_BOOTSTRAP_TOKEN: shared secret embedded in the agent installer for OTT requests.

2. Place the gateway TLS files in env/conf/gateway/issuer/server.pem and server.key (mounted read-only into nginx). Distribute the issuing CA to agent hosts and to administrator browsers.

3. Optional adjustments:
   - Update env/conf/gateway/nginx.conf if you need extra upstreams or want to expose Keycloak via the gateway.
   - Tune oauth2-proxy defaults in env/conf/oidc/oauth2-proxy.cfg (e.g. cookie domain, email allow-list).

---

## 4. Deployment Steps (Server)

> All docker compose commands below assume you run them from the repository root.
```
cd /mnt/c/Users/admin/Desktop/vt-audit/  
docker compose --env-file env/.env -f env/docker-compose.yml build
docker compose --env-file env/.env -f env/docker-compose.yml up -d
docker compose -f env/docker-compose.yml ps
docker compose -f env/docker-compose.yml down -v --remove-orphdockerans
docker system prune -af --volumes
rm -rf env/step env/secrets env/certs/stepca  

docker exec -it vt-stepca bash 

1. tạo provisioner trong ca.json:
docker exec -it vt-stepca bash 
step ca provisioner add bootstrap@vt-audit --type JWK --create

2. tạo provisioner pass:
echo "ChangeMe123!" > .... provisioner.pass

3. tạo root_ca.crt
   docker exec -it vt-stepca step ca certificate "gateway.local" \
      /home/step/certs/server.crt /home/step/certs/server.key \
      --provisioner "${STEPCA_PROVISIONER}" \
      --password-file /home/step/secrets/provisioner.pass \
      --ca-url https://stepca:9000 \
      --root /home/step/certs/root_ca.crt

4. copy đống cert vào  cert/nginx
docker cp vt-stepca:/home/step/certs/server.crt ./env/certs/nginx/server.crt
docker cp vt-stepca:/home/step/certs/server.key ./env/certs/nginx/server.key
docker cp vt-stepca:/home/step/certs/root_ca.crt ./env/certs/nginx/root_ca.crt

5. tạo stepca-chain.crt (bằng powershell admin)
cd C:\Users\admin\Desktop\vt-audit   
Get-Content root_ca.crt, intermediate_ca.crt | Set-Content stepca-chain.crt

6. Vào lấy root_ca.crt install
```

---

## 5. Agent Bootstrap & mTLS Flow

1. Install the Windows agent package (agent.exe or MSI) and configure config.json:

   ```json
   {
     "server": "https://gateway.local/agent",
     "ca_file": "C:/Program Files/VT Agent/ca.pem",
     "bootstrap_token": "<AGENT_BOOTSTRAP_TOKEN>",
     "insecure_skip_verify": false
   }
   ```

2. Enrol once (the service uses the same logic):

   ```powershell
   .\agent.exe enroll
   ```

   The agent requests an OTT, exchanges it with Step-CA for a short-lived client certificate, and stores the cert/key locally for future mTLS calls.

3. Run audits or collect results on demand:

   ```powershell
   .\agent.exe run
   ```

   Results are posted to /agent/results and become visible in the dashboard.

---

## 6. Dashboard SPA

- Served from the dashboard container (nginx) with client-side routing for /audit and /policy.
- Fetches data from /dashboard/api/* (proxied through oauth2-proxy):
  - /dashboard/api/results latest findings with filter support.
  - /dashboard/api/policy/active current Windows policy in YAML.
  - /dashboard/api/policy/history version history.
  - /dashboard/api/policy/save (requires OIDC_ADMIN_ROLE).
  - /dashboard/api/policy/activate (requires OIDC_ADMIN_ROLE).

If the session cookie expires, oauth2-proxy redirects the browser back through the Keycloak login flow.

---

## 7. Certificates & Trust

- **Gateway TLS:** Place server.pem/server.key under env/conf/gateway/issuer/ and distribute the issuing CA to agents and administrator browsers.
- **Step-CA:** The first Step-CA boot initialises /home/step (mounted as stepca_data). Back up the secrets/ directory securely. The gateway mounts the same volume read-only to validate client certificates (ssl_client_certificate /etc/nginx/stepca/certs/root_ca.crt).
- **Agent trust store:** Shipping the gateway CA (ca.pem) with the installer avoids trust prompts on Windows. Alternatively import the CA into the local machine store.

---

## 8. Troubleshooting

| Symptom | Likely Cause | Fix |
|---------|--------------|-----|
| error performing request: Get "http://keycloak:8080/...": dial tcp ... connect: connection refused in oauth2-proxy | Keycloak still starting | Wait for vt-keycloak logs to show Listening on: http://0.0.0.0:8080. The health check now keeps dependent services waiting and restart policies retry automatically. |
| server failed: stepca: read provisioner key: open /stepca/secrets/provisioner.key: no such file or directory in vt-api-agent | Step-CA has not finished initialising or the volume is empty | Allow Step-CA to finish booting (watch docker compose logs -f stepca). vt-api-agent now polls until the key appears; if the error persists, verify the stepca_data volume and STEPCA_PASSWORD. |
| 
nginx: [emerg] host not found in upstream "api-agent:8080" in vt-gateway | api-agent container failed so Docker DNS entry is missing | Resolve the root cause (Step-CA or Postgres). Once api-agent is healthy, restart the gateway: docker compose -f env/docker-compose.yml restart gateway. |
| Dashboard shows OIDC not configured | vt-api-user has not yet loaded the OIDC discovery document | Check api-user logs. It re-attempts discovery until Keycloak is ready. |

Useful commands:

```
# Inspect container state
docker compose -f env/docker-compose.yml ps

# Follow logs
docker compose -f env/docker-compose.yml logs -f stepca keycloak api-agent api-user oidc-proxy gateway

# Verify gateway can reach internal services
docker compose -f env/docker-compose.yml exec gateway sh -c "wget -qO- http://api-agent:8080/health"

# Manual mTLS check
curl -vk --cacert ca.pem --cert client.pem --key client.key https://gateway.local/agent/policy/healthcheck
```

---

## 9. Security Notes

- Never commit .env, provisioner keys, or TLS private keys.
- Restrict access to the Docker host; only expose port 443 publicly.
- Rotate AGENT_BOOTSTRAP_TOKEN, oauth2 secrets, and Step-CA passwords periodically.
- Enable HTTPS for Keycloak in production (either terminate at the gateway or on Keycloak itself).
- Configure log rotation or Docker logging drivers for nginx and oauth2-proxy to avoid disk pressure.

---

## 10. Repository Layout

```
agent/                Windows agent source code
server/               vt-server binary (agent API + admin API)
dashboard/            SPA assets and nginx Dockerfile
env/docker-compose.yml Compose definition for the full stack
env/conf/...          Gateway, oauth2-proxy, and other deployment configs
rules/                Baseline Windows policy definitions
```

With this layout you can customise policies, extend the SPA, or integrate additional observability endpoints without altering the deployment topology described above.

## 11. Test server:
```
curl -k https://localhost:9000/health
http://localhost:8080
curl http://localhost:8081/api/health
https://gateway.local/
```
1. Cấp cert cho nginx
```
   docker exec -it vt-stepca step ca certificate "gateway.local" \
      /home/step/certs/server.crt /home/step/certs/server.key \
      --provisioner "${STEPCA_PROVISIONER}" \
      --password-file /home/step/secrets/provisioner.pass \
      --ca-url https://stepca:9000 \
      --root /home/step/certs/root_ca.crt
```
2. copy ra host
```
docker cp vt-stepca:/home/step/certs/server.crt ./certs/nginx/server.crt
docker cp vt-stepca:/home/step/certs/server.key ./certs/nginx/server.key
docker cp vt-stepca:/home/step/certs/root_ca.crt ./certs/nginx/root_ca.crt
```
3. restart nginx
```
docker compose -f env/docker-compose.yml up -d --build nginx
docker compose -f env/docker-compose.yml down -v
```
Import root CA vào browser.
4. sửa lỗi xung đột docker:
```
docker compose -f env/docker-compose.yml down -v --remove-orphans
docker system prune -af --volumes
wsl --shutdown (nếu nặng)
```

## 12. Tạo agent:
```
go build -o agent.exe .\agent\cmd\vt-agent\main.go
```

sửa lỗi khi nghẽn:
```
rm ~/.docker/config.json
```