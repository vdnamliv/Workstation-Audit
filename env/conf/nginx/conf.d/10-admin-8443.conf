server {
  listen 8443 ssl http2;
  server_name gateway.local localhost _; # Thêm gateway.local để khớp logic test

  ssl_certificate     /etc/nginx/certs/server.crt;
  ssl_certificate_key /etc/nginx/certs/server.key;

  proxy_buffer_size          128k;
  proxy_buffers              4 256k;
  proxy_busy_buffers_size    256k;
  proxy_read_timeout 60s;

  # --- 1. KEYCLOAK (HIDDEN) ---
  # Hứng tất cả traffic /auth/ đưa về Keycloak
  location /auth/ {
    proxy_pass http://keycloak_upstream; # Upstream đã định nghĩa ở 00-upstream.conf
    
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Port  8443;
    
    # Quan trọng: Tăng buffer để tránh lỗi header quá lớn từ Keycloak
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
  }

  # --- 2. OAUTH2-PROXY AUTH ENDPOINT ---
  # Chỉ dùng nội bộ để Nginx check quyền
  location = /oauth2/auth {
    internal;
    proxy_pass       http://oidc_proxy;
    proxy_set_header Host             $host;
    proxy_set_header X-Real-IP        $remote_addr;
    proxy_set_header X-Scheme         $scheme;
    proxy_set_header Content-Length   "";
    proxy_pass_request_body           off;
  }

  # --- 3. OAUTH2-PROXY CALLBACK/START ---
  # Để user login, callback...
  location /oauth2/ {
    proxy_pass       http://oidc_proxy;
    proxy_set_header Host             $host;
    proxy_set_header X-Real-IP        $remote_addr;
    proxy_set_header X-Scheme         $scheme;
  }

  # --- 4. MAIN APP ---
  location / {
    # >>>> BẮT BUỘC CHECK LOGIN TẠI ĐÂY <<<<
    auth_request /oauth2/auth;
    
    # Nếu chưa login (401) -> Redirect sang luồng login của OAuth2-Proxy
    error_page 401 = /oauth2/start;

    # Nếu login OK -> Pass request xuống Backend
    proxy_pass http://api_backend;

    # Truyền thông tin user vào backend (nếu cần)
    auth_request_set $user   $upstream_http_x_auth_request_user;
    auth_request_set $email  $upstream_http_x_auth_request_email;
    auth_request_set $token  $upstream_http_x_auth_request_access_token;
    
    proxy_set_header X-User  $user;
    proxy_set_header X-Email $email;
    proxy_set_header Authorization "Bearer $token";
    
    # Các header chuẩn
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}