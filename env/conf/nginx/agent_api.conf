# base API for agent, require mTLS
upstream api_mtls {
  server workstation-audit:8081 max_fails=3 fail_timeout=10s;
  keepalive 64;
}

# ===========================
# 1) Agent mTLS API surface
# ===========================
server {
  listen 443 ssl http2;
  server_name agent-mtls.yourdomain.com;

  ssl_certificate     /etc/letsencrypt/live/agent-mtls.yourdomain.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/agent-mtls.yourdomain.com/privkey.pem;

  # Require client mTLS for agents
  ssl_client_certificate /etc/nginx/certs/clients_ca_chain.pem;
  ssl_verify_client on;         # only client-certâ€™d agents allowed
  ssl_verify_depth 2;

  # Tighten ciphers if desired; keep short timeouts for agent calls
  proxy_read_timeout 30s;

  location / {
    proxy_set_header Host                $host;
    proxy_set_header X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto   $scheme;

    # (Optionally pass client identity to the backend)
    proxy_set_header X-Client-Subject    $ssl_client_s_dn;
    proxy_set_header X-Client-Verify     $ssl_client_verify;

    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_pass http://api_mtls;
  }
}
